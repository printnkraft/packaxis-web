{% extends "base.html" %}
{% load static %}

{% block title %}My Account - PackAxis{% endblock %}

{% block extra_head %}
<meta name="robots" content="noindex, nofollow">
{% endblock %}

{% block content %}
<!-- Breadcrumb Navigation -->
<nav class="breadcrumb-nav" aria-label="Breadcrumb">
  <div class="container">
    <ol class="breadcrumb-list">
      <li class="breadcrumb-item">
        <a href="{% url 'home' %}" class="breadcrumb-link">Home</a>
      </li>
      <li class="breadcrumb-separator" aria-hidden="true">
        <span class="material-symbols-rounded">chevron_right</span>
      </li>
      <li class="breadcrumb-item breadcrumb-item--current">
        <span aria-current="page">My Account</span>
      </li>
    </ol>
  </div>
</nav>

<!-- Account Dashboard -->
<section class="acc-dashboard">
  <div class="container">
    <div class="acc-grid">
      <!-- Sidebar -->
      <aside class="acc-sidebar">
        <!-- User Profile Card -->
        <div class="acc-profile-card">
          <div class="acc-avatar">
            {% if user.is_authenticated and user.first_name %}
              <span class="acc-avatar__initials">{{ user.first_name|first|upper }}{{ user.last_name|first|upper }}</span>
            {% else %}
              <span class="material-symbols-rounded">person</span>
            {% endif %}
          </div>
          <div class="acc-profile-info">
            <h2 class="acc-profile-name" id="user-display-name">
              {% if user.is_authenticated %}
                {% if user.first_name %}{{ user.first_name }} {{ user.last_name }}{% else %}{{ user.username }}{% endif %}
              {% else %}
                Guest User
              {% endif %}
            </h2>
            <p class="acc-profile-email" id="user-email">
              {% if user.is_authenticated %}{{ user.email }}{% else %}Please log in{% endif %}
            </p>
            <span class="acc-badge acc-badge--verified">
              <span class="material-symbols-rounded">verified</span>
              Verified Account
            </span>
          </div>
        </div>

        <!-- Navigation -->
        <nav class="acc-nav" aria-label="Account navigation">
          <ul class="acc-nav__list">
            <li class="acc-nav__item">
              <button class="acc-nav__link is-active" data-section="overview" type="button">
                <span class="material-symbols-rounded">dashboard</span>
                <span>Overview</span>
              </button>
            </li>
            <li class="acc-nav__item">
              <button class="acc-nav__link" data-section="orders" type="button">
                <span class="material-symbols-rounded">package_2</span>
                <span>Orders</span>
              </button>
            </li>
            <li class="acc-nav__item">
              <button class="acc-nav__link" data-section="addresses" type="button">
                <span class="material-symbols-rounded">location_on</span>
                <span>Addresses</span>
              </button>
            </li>
            <li class="acc-nav__item">
              <button class="acc-nav__link" data-section="settings" type="button">
                <span class="material-symbols-rounded">settings</span>
                <span>Settings</span>
              </button>
            </li>
            <li class="acc-nav__item acc-nav__item--divider">
            <li class="acc-nav__item">
              <button class="acc-nav__link" data-section="wishlist" type="button">
                <span class="material-symbols-rounded">favorite</span>
                <span>Wishlist</span>
              </button>
            </li>
            <li class="acc-nav__item acc-nav__item--divider"></li>
            <li class="acc-nav__item">
              <a href="/accounts/logout/" class="acc-nav__link acc-nav__link--danger">
                <span class="material-symbols-rounded">logout</span>
                <span>Sign Out</span>
              </a>
            </li>
          </ul>
        </nav>

        <!-- Help Card -->
        <div class="acc-help-card">
          <span class="material-symbols-rounded acc-help-card__icon">support_agent</span>
          <h4 class="acc-help-card__title">Need Help?</h4>
          <p class="acc-help-card__text">Our team is here to assist you with any questions.</p>
          <a href="mailto:support@packaxis.com" class="acc-help-card__btn">
            <span class="material-symbols-rounded">mail</span>
            Contact Support
          </a>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="acc-main">
        <!-- Overview Section -->
        <section id="section-overview" class="acc-section">
          <!-- Welcome Banner -->
          <div class="acc-welcome">
            <div class="acc-welcome__content">
              <p class="acc-welcome__greeting">Welcome back,</p>
              <h1 class="acc-welcome__name">
                {% if user.is_authenticated and user.first_name %}{{ user.first_name }}{% else %}there{% endif %}! ðŸ‘‹
              </h1>
              <p class="acc-welcome__subtitle">Here's an overview of your account activity.</p>
            </div>
            <div class="acc-welcome__visual">
              <span class="material-symbols-rounded">inventory_2</span>
            </div>
          </div>

          <!-- Stats Grid -->
          <div class="acc-stats">
            <div class="acc-stat-card acc-stat-card--primary">
              <div class="acc-stat-card__icon">
                <span class="material-symbols-rounded">package_2</span>
              </div>
              <div class="acc-stat-card__content">
                <span class="acc-stat-card__value" id="stat-total-orders">â€”</span>
                <span class="acc-stat-card__label">Total Orders</span>
              </div>
            </div>
            <div class="acc-stat-card acc-stat-card--accent">
              <div class="acc-stat-card__icon">
                <span class="material-symbols-rounded">local_shipping</span>
              </div>
              <div class="acc-stat-card__content">
                <span class="acc-stat-card__value" id="stat-in-transit">â€”</span>
                <span class="acc-stat-card__label">In Transit</span>
              </div>
            </div>
            <div class="acc-stat-card acc-stat-card--success">
              <div class="acc-stat-card__icon">
                <span class="material-symbols-rounded">payments</span>
              </div>
              <div class="acc-stat-card__content">
                <span class="acc-stat-card__value" id="stat-total-spent">â€”</span>
                <span class="acc-stat-card__label">Total Spent</span>
              </div>
            </div>
          </div>

          <!-- Recent Orders Card -->
          <div class="acc-card">
            <div class="acc-card__header">
              <div class="acc-card__header-left">
                <h2 class="acc-card__title">
                  <span class="material-symbols-rounded">schedule</span>
                  Recent Orders
                </h2>
                <p class="acc-card__subtitle">Your latest order activity</p>
              </div>
              <button class="acc-card__action" data-section="orders" type="button">
                View All
                <span class="material-symbols-rounded">arrow_forward</span>
              </button>
            </div>
            <div class="acc-card__body" id="recent-orders-container">
              <div class="acc-loading">
                <div class="acc-loading__spinner"></div>
                <p class="acc-loading__text">Loading orders...</p>
              </div>
            </div>
          </div>

          <!-- Quick Actions -->
          <div class="acc-quick-actions">
            <h3 class="acc-quick-actions__title">Quick Actions</h3>
            <div class="acc-quick-actions__grid">
              <a href="/products/" class="acc-action-card">
                <span class="material-symbols-rounded">shopping_bag</span>
                <span>Browse Products</span>
              </a>
              <button class="acc-action-card" data-section="orders" type="button">
                <span class="material-symbols-rounded">track_changes</span>
                <span>Track Orders</span>
              </button>
              <button class="acc-action-card" data-section="addresses" type="button">
                <span class="material-symbols-rounded">add_location</span>
                <span>Manage Addresses</span>
              </button>
              <a href="mailto:support@packaxis.com" class="acc-action-card">
                <span class="material-symbols-rounded">help</span>
                <span>Get Help</span>
              </a>
            </div>
          </div>
        </section>

        <!-- Orders Section -->
        <section id="section-orders" class="acc-section is-hidden">
          <div class="acc-section-header">
            <div class="acc-section-header__left">
              <h2 class="acc-section-header__title">
                <span class="material-symbols-rounded">package_2</span>
                My Orders
              </h2>
              <p class="acc-section-header__subtitle">View and track all your orders</p>
            </div>
          </div>

          <!-- Orders Filter -->
          <div class="acc-orders-filter">
            <button class="acc-filter-btn is-active" data-filter="all">All Orders</button>
            <button class="acc-filter-btn" data-filter="processing">Processing</button>
            <button class="acc-filter-btn" data-filter="shipped">Shipped</button>
            <button class="acc-filter-btn" data-filter="delivered">Delivered</button>
          </div>

          <div id="orders-list-container" class="acc-orders-list">
            <div class="acc-loading">
              <div class="acc-loading__spinner"></div>
              <p class="acc-loading__text">Loading orders...</p>
            </div>
          </div>
        </section>

        <!-- Addresses Section -->
        <section id="section-addresses" class="acc-section is-hidden">
          <div class="acc-section-header">
            <div class="acc-section-header__left">
              <h2 class="acc-section-header__title">
                <span class="material-symbols-rounded">location_on</span>
                My Addresses
              </h2>
              <p class="acc-section-header__subtitle">Manage your shipping and billing addresses for quick checkout</p>
            </div>
            <button class="btn btn-primary btn-sm" id="btn-add-address" type="button">
              <span class="material-symbols-rounded">add</span>
              Add New Address
            </button>
          </div>

          <div id="addresses-container" class="acc-addresses-grid">
            <div class="acc-loading">
              <div class="acc-loading__spinner"></div>
              <p class="acc-loading__text">Loading addresses...</p>
            </div>
          </div>
        </section>

        <!-- Settings Section -->
        <section id="section-settings" class="acc-section is-hidden">
          <div class="acc-section-header">
            <h2 class="acc-section-header__title">
              <span class="material-symbols-rounded">settings</span>
              Account Settings
            </h2>
            <p class="acc-section-header__subtitle">Update your personal information and preferences</p>
          </div>

          <!-- Profile Settings Card -->
          <div class="acc-card">
            <div class="acc-card__header">
              <div class="acc-card__header-left">
                <h3 class="acc-card__title">Personal Information</h3>
                <p class="acc-card__subtitle">Update your profile details</p>
              </div>
            </div>
            <div class="acc-card__body">
              <form class="acc-form" id="profile-form">
                <div class="acc-form__row">
                  <div class="acc-form__group">
                    <label class="acc-form__label" for="first-name">First Name</label>
                    <input type="text" id="first-name" class="acc-form__input" 
                           value="{% if user.is_authenticated %}{{ user.first_name }}{% endif %}" 
                           placeholder="Enter first name">
                  </div>
                  <div class="acc-form__group">
                    <label class="acc-form__label" for="last-name">Last Name</label>
                    <input type="text" id="last-name" class="acc-form__input" 
                           value="{% if user.is_authenticated %}{{ user.last_name }}{% endif %}" 
                           placeholder="Enter last name">
                  </div>
                </div>
                <div class="acc-form__group">
                  <label class="acc-form__label" for="email">Email Address</label>
                  <input type="email" id="email" class="acc-form__input" 
                         value="{% if user.is_authenticated %}{{ user.email }}{% endif %}" 
                         placeholder="Enter email address">
                </div>
                <div class="acc-form__group">
                  <label class="acc-form__label" for="phone">Phone Number</label>
                  <input type="tel" id="phone" class="acc-form__input" placeholder="Enter phone number">
                </div>
                <div class="acc-form__actions">
                  <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
              </form>
            </div>
          </div>

          <!-- Password Card -->
          <div class="acc-card">
            <div class="acc-card__header">
              <div class="acc-card__header-left">
                <h3 class="acc-card__title">Security</h3>
                <p class="acc-card__subtitle">Update your password</p>
              </div>
            </div>
            <div class="acc-card__body">
              <form class="acc-form" id="password-form">
                <div class="acc-form__group">
                  <label class="acc-form__label" for="current-password">Current Password</label>
                  <input type="password" id="current-password" class="acc-form__input" 
                         placeholder="Enter current password">
                </div>
                <div class="acc-form__row">
                  <div class="acc-form__group">
                    <label class="acc-form__label" for="new-password">New Password</label>
                    <input type="password" id="new-password" class="acc-form__input" 
                           placeholder="Enter new password">
                  </div>
                  <div class="acc-form__group">
                    <label class="acc-form__label" for="confirm-password">Confirm Password</label>
                    <input type="password" id="confirm-password" class="acc-form__input" 
                           placeholder="Confirm new password">
                  </div>
                </div>
                <div class="acc-form__actions">
                  <button type="submit" class="btn btn-secondary">Update Password</button>
                </div>
              </form>
            </div>
          </div>

          <!-- Notifications Card -->
          <div class="acc-card">
            <div class="acc-card__header">
              <div class="acc-card__header-left">
                <h3 class="acc-card__title">Email Notifications</h3>
                <p class="acc-card__subtitle">Manage your email preferences</p>
              </div>
            </div>
            <div class="acc-card__body">
              <div class="acc-toggles">
                <label class="acc-toggle">
                  <input type="checkbox" class="acc-toggle__input" checked>
                  <span class="acc-toggle__slider"></span>
                  <span class="acc-toggle__content">
                    <span class="acc-toggle__label">Order Updates</span>
                    <span class="acc-toggle__hint">Get notified about order status changes</span>
                  </span>
                </label>
                <label class="acc-toggle">
                  <input type="checkbox" class="acc-toggle__input" checked>
                  <span class="acc-toggle__slider"></span>
                  <span class="acc-toggle__content">
                    <span class="acc-toggle__label">Shipping Notifications</span>
                    <span class="acc-toggle__hint">Receive tracking updates and delivery alerts</span>
                  </span>
                </label>
                <label class="acc-toggle">
                  <input type="checkbox" class="acc-toggle__input">
                  <span class="acc-toggle__slider"></span>
                  <span class="acc-toggle__content">
                    <span class="acc-toggle__label">Promotional Emails</span>
                    <span class="acc-toggle__hint">Get exclusive offers and product updates</span>
                  </span>
                </label>
              </div>
            </div>
          </div>
        </section>

        <!-- Wishlist Section -->
        <section id="section-wishlist" class="acc-section is-hidden">
          <div class="acc-section-header">
            <h2 class="acc-section-header__title">
              <span class="material-symbols-rounded">favorite</span>
              My Wishlist
            </h2>
            <p class="acc-section-header__subtitle">Products you have saved for later</p>
          </div>

          <!-- Wishlist Stats -->
          <div class="acc-wishlist-stats" id="wishlist-stats" style="display: none;">
            <div class="acc-wishlist-stats__item">
              <span class="material-symbols-rounded">favorite</span>
              <span><strong id="wishlist-count">0</strong> items saved</span>
            </div>
            <div class="acc-wishlist-stats__divider"></div>
            <div class="acc-wishlist-stats__item">
              <span class="material-symbols-rounded">inventory_2</span>
              <span><strong id="wishlist-in-stock">0</strong> in stock</span>
            </div>
          </div>

          <!-- Wishlist Content -->
          <div class="acc-card">
            <div id="wishlist-content">
              <div class="acc-loading">
                <div class="acc-loading__spinner"></div>
                <p class="acc-loading__text">Loading wishlist...</p>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>
</section>

<!-- Address Modal -->
<div class="acc-modal" id="address-modal" aria-hidden="true">
  <div class="acc-modal__backdrop"></div>
  <div class="acc-modal__container">
    <div class="acc-modal__content">
      <div class="acc-modal__header">
        <h3 class="acc-modal__title" id="address-modal-title">Add New Address</h3>
        <button class="acc-modal__close" type="button" aria-label="Close modal">
          <span class="material-symbols-rounded">close</span>
        </button>
      </div>
      <form class="acc-modal__body" id="address-form">
        <input type="hidden" id="address-id" value="">
        <div class="acc-form__row">
          <div class="acc-form__group">
            <label class="acc-form__label" for="addr-first-name">First Name *</label>
            <input type="text" id="addr-first-name" class="acc-form__input" required placeholder="John">
          </div>
          <div class="acc-form__group">
            <label class="acc-form__label" for="addr-last-name">Last Name *</label>
            <input type="text" id="addr-last-name" class="acc-form__input" required placeholder="Doe">
          </div>
        </div>
        <div class="acc-form__group">
          <label class="acc-form__label" for="addr-company">Company (Optional)</label>
          <input type="text" id="addr-company" class="acc-form__input" placeholder="Company name">
        </div>
        <div class="acc-form__group">
          <label class="acc-form__label" for="addr-address1">Address Line 1 *</label>
          <input type="text" id="addr-address1" class="acc-form__input" required placeholder="123 Main Street">
        </div>
        <div class="acc-form__group">
          <label class="acc-form__label" for="addr-address2">Address Line 2 (Optional)</label>
          <input type="text" id="addr-address2" class="acc-form__input" placeholder="Apt, Suite, Unit, etc.">
        </div>
        <div class="acc-form__row acc-form__row--3">
          <div class="acc-form__group">
            <label class="acc-form__label" for="addr-city">City *</label>
            <input type="text" id="addr-city" class="acc-form__input" required placeholder="Toronto">
          </div>
          <div class="acc-form__group">
            <label class="acc-form__label" for="addr-province">Province *</label>
            <select id="addr-province" class="acc-form__input" required>
              <option value="">Select...</option>
              <option value="AB">Alberta</option>
              <option value="BC">British Columbia</option>
              <option value="MB">Manitoba</option>
              <option value="NB">New Brunswick</option>
              <option value="NL">Newfoundland and Labrador</option>
              <option value="NS">Nova Scotia</option>
              <option value="NT">Northwest Territories</option>
              <option value="NU">Nunavut</option>
              <option value="ON">Ontario</option>
              <option value="PE">Prince Edward Island</option>
              <option value="QC">Quebec</option>
              <option value="SK">Saskatchewan</option>
              <option value="YT">Yukon</option>
            </select>
          </div>
          <div class="acc-form__group">
            <label class="acc-form__label" for="addr-postal">Postal Code *</label>
            <input type="text" id="addr-postal" class="acc-form__input" required placeholder="M5V 1A1" maxlength="7">
          </div>
        </div>
        <div class="acc-form__group">
          <label class="acc-form__label" for="addr-phone">Phone (Optional)</label>
          <input type="tel" id="addr-phone" class="acc-form__input" placeholder="(416) 555-1234">
        </div>
        <div class="acc-form__checkboxes">
          <label class="acc-checkbox">
            <input type="checkbox" id="addr-default-shipping">
            <span class="acc-checkbox__mark"></span>
            <span>Set as default shipping address</span>
          </label>
          <label class="acc-checkbox">
            <input type="checkbox" id="addr-default-billing">
            <span class="acc-checkbox__mark"></span>
            <span>Set as default billing address</span>
          </label>
        </div>
      </form>
      <div class="acc-modal__footer">
        <button type="button" class="btn btn-secondary" id="btn-cancel-address">Cancel</button>
        <button type="submit" form="address-form" class="btn btn-primary" id="btn-save-address">Save Address</button>
      </div>
    </div>
  </div>
</div>

<!-- Order Detail Modal -->
<div class="acc-modal acc-modal--xl" id="order-modal" aria-hidden="true">
  <div class="acc-modal__backdrop"></div>
  <div class="acc-modal__container">
    <div class="acc-modal__content">
      <div class="acc-modal__header">
        <div class="acc-modal__header-info">
          <h3 class="acc-modal__title" id="order-modal-title">Order Details</h3>
          <span class="acc-modal__subtitle" id="order-modal-subtitle"></span>
        </div>
        <div class="acc-modal__header-actions">
          <button class="btn btn-secondary btn-sm" id="btn-download-invoice" type="button">
            <span class="material-symbols-rounded">download</span>
            Download Invoice
          </button>
          <button class="acc-modal__close" type="button" aria-label="Close modal">
            <span class="material-symbols-rounded">close</span>
          </button>
        </div>
      </div>
      <div class="acc-modal__body" id="order-modal-body">
        <div class="acc-loading">
          <div class="acc-loading__spinner"></div>
          <p class="acc-loading__text">Loading order details...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  'use strict';

  // State
  let addresses = [];
  let orders = [];
  let currentFilter = 'all';

  // Utility functions
  function getCsrfToken() {
    const match = document.cookie.match('(^|;)\\s*csrftoken\\s*=\\s*([^;]+)');
    return match ? match[2] : '';
  }

  function formatDate(dateString) {
    const date = new Date(dateString);
    if (Number.isNaN(date.getTime())) return 'â€”';
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  }

  function formatDateTime(dateString) {
    const date = new Date(dateString);
    if (Number.isNaN(date.getTime())) return 'â€”';
    return date.toLocaleDateString('en-US', { 
      month: 'short', day: 'numeric', year: 'numeric',
      hour: 'numeric', minute: '2-digit'
    });
  }

  function formatCurrency(amount) {
    const num = parseFloat(amount);
    if (Number.isNaN(num)) return '$0.00';
    return '$' + num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }

  function getStatusClass(status) {
    const normalized = (status || '').toLowerCase();
    const map = {
      pending: 'acc-status--pending',
      processing: 'acc-status--processing',
      shipped: 'acc-status--shipped',
      in_transit: 'acc-status--shipped',
      delivered: 'acc-status--delivered',
      cancelled: 'acc-status--cancelled',
      refunded: 'acc-status--cancelled'
    };
    return map[normalized] || 'acc-status--neutral';
  }

  function getShipmentStatusClass(status) {
    const normalized = (status || '').toLowerCase();
    const map = {
      pending: 'acc-shipment-status--pending',
      in_transit: 'acc-shipment-status--transit',
      out_for_delivery: 'acc-shipment-status--delivery',
      delivered: 'acc-shipment-status--delivered',
      failed: 'acc-shipment-status--failed',
      returned: 'acc-shipment-status--failed'
    };
    return map[normalized] || 'acc-shipment-status--pending';
  }

  // Section navigation
  function showSection(sectionName) {
    document.querySelectorAll('.acc-section').forEach(section => {
      section.classList.add('is-hidden');
    });
    
    const target = document.getElementById('section-' + sectionName);
    if (target) {
      target.classList.remove('is-hidden');
    }
    
    document.querySelectorAll('.acc-nav__link').forEach(link => {
      const linkSection = link.dataset.section;
      link.classList.toggle('is-active', linkSection === sectionName);
    });

    // Load data for section
    if (sectionName === 'orders') {
      renderOrdersList();
    } else if (sectionName === 'addresses') {
      renderAddresses();
    }
  }

  // Modal functions
  function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';
    }
  }

  function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
    }
  }

  // Stats update
  function updateStats() {
    const totalOrders = orders.length;
    const inTransitStatuses = new Set(['processing', 'shipped', 'in_transit', 'transit']);
    const inTransit = orders.filter(o => inTransitStatuses.has((o.status || '').toLowerCase())).length;
    const totalSpent = orders.reduce((sum, o) => sum + (parseFloat(o.total_amount || o.total) || 0), 0);

    document.getElementById('stat-total-orders').textContent = totalOrders;
    document.getElementById('stat-in-transit').textContent = inTransit;
    document.getElementById('stat-total-spent').textContent = formatCurrency(totalSpent);
  }

  // Render recent orders on overview
  function renderRecentOrders() {
    const container = document.getElementById('recent-orders-container');
    if (!container) return;

    const recentOrders = orders.slice(0, 5);

    if (recentOrders.length === 0) {
      container.innerHTML = `
        <div class="acc-empty">
          <span class="material-symbols-rounded acc-empty__icon">inventory_2</span>
          <h4 class="acc-empty__title">No orders yet</h4>
          <p class="acc-empty__text">Start shopping to see your orders here.</p>
          <a href="/products/" class="btn btn-primary">Browse Products</a>
        </div>
      `;
      return;
    }

    container.innerHTML = `
      <div class="acc-table-wrapper">
        <table class="acc-table">
          <thead>
            <tr>
              <th>Order</th>
              <th>Date</th>
              <th>Status</th>
              <th>Total</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            ${recentOrders.map(order => `
              <tr>
                <td class="acc-table__order-id">#${order.order_number || order.id}</td>
                <td class="acc-table__date">${formatDate(order.created_at)}</td>
                <td>
                  <span class="acc-status ${getStatusClass(order.status)}">${order.status_display || order.status}</span>
                </td>
                <td class="acc-table__amount">${formatCurrency(order.total_amount || order.total)}</td>
                <td>
                  <button class="acc-table__link" data-view-order="${order.id}" type="button">
                    View
                    <span class="material-symbols-rounded">chevron_right</span>
                  </button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    `;
  }

  // Render full orders list
  function renderOrdersList() {
    const container = document.getElementById('orders-list-container');
    if (!container) return;

    let filteredOrders = orders;
    if (currentFilter !== 'all') {
      filteredOrders = orders.filter(o => (o.status || '').toLowerCase() === currentFilter.toLowerCase());
    }

    if (filteredOrders.length === 0) {
      container.innerHTML = `
        <div class="acc-empty">
          <span class="material-symbols-rounded acc-empty__icon">inventory_2</span>
          <h4 class="acc-empty__title">${currentFilter === 'all' ? 'No orders yet' : 'No ' + currentFilter + ' orders'}</h4>
          <p class="acc-empty__text">${currentFilter === 'all' ? 'Start shopping to see your orders here.' : 'You have no orders with this status.'}</p>
          ${currentFilter === 'all' ? '<a href="/products/" class="btn btn-primary">Browse Products</a>' : ''}
        </div>
      `;
      return;
    }

    container.innerHTML = filteredOrders.map(order => {
      const hasShipments = order.shipments && order.shipments.length > 0;
      return `
        <div class="acc-order-card">
          <div class="acc-order-card__header">
            <div class="acc-order-card__info">
              <div class="acc-order-card__number">#${order.order_number || order.id}</div>
              <div class="acc-order-card__date">${formatDate(order.created_at)}</div>
            </div>
            <span class="acc-status ${getStatusClass(order.status)}">${order.status_display || order.status}</span>
          </div>
          <div class="acc-order-card__body">
            <div class="acc-order-card__summary">
              <div class="acc-order-card__items">
                ${order.lines ? order.lines.slice(0, 3).map(line => `
                  <div class="acc-order-item">
                    ${line.product_image ? `<img src="${line.product_image}" alt="" class="acc-order-item__img">` : `<div class="acc-order-item__img acc-order-item__img--placeholder"><span class="material-symbols-rounded">inventory_2</span></div>`}
                    <div class="acc-order-item__info">
                      <span class="acc-order-item__name">${line.product_name || 'Product'}</span>
                      <span class="acc-order-item__qty">Qty: ${line.quantity}</span>
                    </div>
                  </div>
                `).join('') : '<span class="text-muted">Loading items...</span>'}
                ${order.lines && order.lines.length > 3 ? `<div class="acc-order-card__more">+${order.lines.length - 3} more items</div>` : ''}
              </div>
              <div class="acc-order-card__total">
                <span class="acc-order-card__total-label">Total</span>
                <span class="acc-order-card__total-amount">${formatCurrency(order.total_amount || order.total)}</span>
              </div>
            </div>
            ${hasShipments ? `
              <div class="acc-order-card__tracking">
                <div class="acc-tracking-header">
                  <span class="material-symbols-rounded">local_shipping</span>
                  <span>Tracking Information</span>
                </div>
                ${order.shipments.map(shipment => `
                  <div class="acc-tracking-item">
                    <div class="acc-tracking-item__carrier">
                      <strong>${shipment.carrier}</strong>
                      <span class="acc-shipment-status ${getShipmentStatusClass(shipment.status)}">${shipment.status_display || shipment.status}</span>
                    </div>
                    <div class="acc-tracking-item__number">
                      ${shipment.tracking_url ? `<a href="${shipment.tracking_url}" target="_blank" rel="noopener">${shipment.tracking_number} <span class="material-symbols-rounded">open_in_new</span></a>` : shipment.tracking_number}
                    </div>
                    ${shipment.estimated_delivery ? `
                      <div class="acc-tracking-item__eta">
                        <span class="material-symbols-rounded">event</span>
                        Est. Delivery: ${formatDate(shipment.estimated_delivery)}
                      </div>
                    ` : ''}
                    <div class="acc-tracking-item__updated">
                      Last updated: ${formatDateTime(shipment.last_updated)}
                    </div>
                  </div>
                `).join('')}
              </div>
            ` : ''}
          </div>
          <div class="acc-order-card__footer">
            <button class="btn btn-secondary btn-sm" data-view-order="${order.id}" type="button">
              <span class="material-symbols-rounded">visibility</span>
              View Details
            </button>
            ${hasShipments && order.shipments[0].tracking_url ? `
              <a href="${order.shipments[0].tracking_url}" target="_blank" rel="noopener" class="btn btn-primary btn-sm">
                <span class="material-symbols-rounded">local_shipping</span>
                Track Package
              </a>
            ` : ''}
          </div>
        </div>
      `;
    }).join('');
  }

  // View order details
  async function viewOrderDetails(orderId) {
    const order = orders.find(o => o.id == orderId);
    if (!order) return;

    const orderNum = order.order_number || order.id;
    document.getElementById('order-modal-title').textContent = `Order #${orderNum}`;
    document.getElementById('order-modal-subtitle').textContent = `Placed on ${formatDateTime(order.created_at)}`;
    
    // Store order data for invoice download
    window.currentOrderData = order;
    
    openModal('order-modal');

    const body = document.getElementById('order-modal-body');
    const hasShipments = order.shipments && order.shipments.length > 0;
    const hasDiscount = order.discount_amount && parseFloat(order.discount_amount) > 0;
    const totalItems = order.lines ? order.lines.reduce((sum, line) => sum + line.quantity, 0) : 0;

    body.innerHTML = `
      <div class="acc-order-detail">
        <!-- Order Header Info Card -->
        <div class="acc-order-detail__header-card">
          <div class="acc-order-detail__status-row">
            <span class="acc-status acc-status--lg ${getStatusClass(order.status)}">${order.status_display || order.status}</span>
            ${order.payment_status ? `<span class="acc-status acc-status--payment ${order.payment_status === 'paid' ? 'acc-status--success' : 'acc-status--warning'}">${order.payment_status === 'paid' ? 'Paid' : order.payment_status}</span>` : ''}
          </div>
          <div class="acc-order-detail__meta-grid">
            <div class="acc-order-detail__meta-item">
              <span class="material-symbols-rounded">tag</span>
              <div>
                <span class="acc-order-detail__meta-label">Order Number</span>
                <span class="acc-order-detail__meta-value">#${orderNum}</span>
              </div>
            </div>
            <div class="acc-order-detail__meta-item">
              <span class="material-symbols-rounded">calendar_today</span>
              <div>
                <span class="acc-order-detail__meta-label">Order Date</span>
                <span class="acc-order-detail__meta-value">${formatDate(order.created_at)}</span>
              </div>
            </div>
            <div class="acc-order-detail__meta-item">
              <span class="material-symbols-rounded">shopping_cart</span>
              <div>
                <span class="acc-order-detail__meta-label">Total Items</span>
                <span class="acc-order-detail__meta-value">${totalItems} item${totalItems !== 1 ? 's' : ''}</span>
              </div>
            </div>
            <div class="acc-order-detail__meta-item">
              <span class="material-symbols-rounded">payments</span>
              <div>
                <span class="acc-order-detail__meta-label">Payment Method</span>
                <span class="acc-order-detail__meta-value">${order.payment_method || 'Credit Card'}</span>
              </div>
            </div>
          </div>
        </div>

        ${hasShipments ? `
          <div class="acc-order-detail__section">
            <h4 class="acc-order-detail__section-title">
              <span class="material-symbols-rounded">local_shipping</span>
              Shipment Tracking
            </h4>
            <div class="acc-tracking-cards">
              ${order.shipments.map((shipment, idx) => `
                <div class="acc-tracking-card">
                  <div class="acc-tracking-card__header">
                    <span class="acc-tracking-card__label">Shipment #${idx + 1}</span>
                    <span class="acc-shipment-status ${getShipmentStatusClass(shipment.status)}">${shipment.status_display || shipment.status}</span>
                  </div>
                  <div class="acc-tracking-card__body">
                    <div class="acc-tracking-card__row">
                      <span class="acc-tracking-card__label">Carrier:</span>
                      <span class="acc-tracking-card__value">${shipment.carrier}</span>
                    </div>
                    <div class="acc-tracking-card__row">
                      <span class="acc-tracking-card__label">Tracking:</span>
                      <span class="acc-tracking-card__value">
                        ${shipment.tracking_url ? `<a href="${shipment.tracking_url}" target="_blank" rel="noopener">${shipment.tracking_number} <span class="material-symbols-rounded">open_in_new</span></a>` : shipment.tracking_number}
                      </span>
                    </div>
                    ${shipment.estimated_delivery ? `
                      <div class="acc-tracking-card__row">
                        <span class="acc-tracking-card__label">Est. Delivery:</span>
                        <span class="acc-tracking-card__value">${formatDate(shipment.estimated_delivery)}</span>
                      </div>
                    ` : ''}
                  </div>
                  ${shipment.tracking_url ? `
                    <a href="${shipment.tracking_url}" target="_blank" rel="noopener" class="btn btn-primary btn-sm btn-block">
                      <span class="material-symbols-rounded">open_in_new</span>
                      Track on ${shipment.carrier}
                    </a>
                  ` : ''}
                </div>
              `).join('')}
            </div>
          </div>
        ` : `
          <div class="acc-order-detail__section">
            <div class="acc-notice acc-notice--info">
              <span class="material-symbols-rounded">info</span>
              <span>Tracking information will be available once your order ships.</span>
            </div>
          </div>
        `}

        <div class="acc-order-detail__section">
          <h4 class="acc-order-detail__section-title">
            <span class="material-symbols-rounded">shopping_bag</span>
            Order Items (${totalItems})
          </h4>
          <div class="acc-order-items">
            ${order.lines ? order.lines.map(line => `
              <div class="acc-order-detail-item">
                ${line.product_image ? `<img src="${line.product_image}" alt="${line.product_name || 'Product'}" class="acc-order-detail-item__img">` : `<div class="acc-order-detail-item__img acc-order-detail-item__img--placeholder"><span class="material-symbols-rounded">inventory_2</span></div>`}
                <div class="acc-order-detail-item__info">
                  <div class="acc-order-detail-item__name">${line.product_name || 'Product'}</div>
                  ${line.sku ? `<div class="acc-order-detail-item__sku">SKU: ${line.sku}</div>` : ''}
                  <div class="acc-order-detail-item__meta">
                    <span>Qty: ${line.quantity}</span>
                    <span class="acc-order-detail-item__unit-price">@ ${formatCurrency(line.unit_price)} each</span>
                  </div>
                </div>
                <div class="acc-order-detail-item__total">
                  <span class="acc-order-detail-item__price">${formatCurrency(line.unit_price * line.quantity)}</span>
                </div>
              </div>
            `).join('') : '<p class="text-muted">No items found</p>'}
          </div>
        </div>

        <div class="acc-order-detail__grid">
          <div class="acc-order-detail__section">
            <h4 class="acc-order-detail__section-title">
              <span class="material-symbols-rounded">local_shipping</span>
              Shipping Address
            </h4>
            ${order.shipping_address ? `
              <div class="acc-address-block">
                <p class="acc-address-block__name">${order.shipping_address.first_name} ${order.shipping_address.last_name}</p>
                ${order.shipping_address.company ? `<p class="acc-address-block__company">${order.shipping_address.company}</p>` : ''}
                <p>${order.shipping_address.address1}</p>
                ${order.shipping_address.address2 ? `<p>${order.shipping_address.address2}</p>` : ''}
                <p>${order.shipping_address.city}, ${order.shipping_address.province} ${order.shipping_address.postal_code}</p>
                <p>${order.shipping_address.country || 'Canada'}</p>
                ${order.shipping_address.phone ? `<p class="acc-address-block__phone"><span class="material-symbols-rounded">phone</span> ${order.shipping_address.phone}</p>` : ''}
              </div>
            ` : '<p class="text-muted">Not available</p>'}
            
            ${order.billing_address ? `
              <h4 class="acc-order-detail__section-title" style="margin-top: var(--space-4);">
                <span class="material-symbols-rounded">receipt_long</span>
                Billing Address
              </h4>
              <div class="acc-address-block">
                <p class="acc-address-block__name">${order.billing_address.first_name} ${order.billing_address.last_name}</p>
                ${order.billing_address.company ? `<p class="acc-address-block__company">${order.billing_address.company}</p>` : ''}
                <p>${order.billing_address.address1}</p>
                ${order.billing_address.address2 ? `<p>${order.billing_address.address2}</p>` : ''}
                <p>${order.billing_address.city}, ${order.billing_address.province} ${order.billing_address.postal_code}</p>
              </div>
            ` : ''}
          </div>

          <div class="acc-order-detail__section">
            <h4 class="acc-order-detail__section-title">
              <span class="material-symbols-rounded">receipt</span>
              Order Summary
            </h4>
            <div class="acc-order-summary">
              <div class="acc-order-summary__row">
                <span>Subtotal (${totalItems} item${totalItems !== 1 ? 's' : ''})</span>
                <span>${formatCurrency(order.subtotal)}</span>
              </div>
              ${hasDiscount ? `
                <div class="acc-order-summary__row acc-order-summary__row--discount">
                  <span>
                    <span class="material-symbols-rounded">local_offer</span>
                    Discount ${order.promo_code ? `(${order.promo_code})` : ''}
                  </span>
                  <span class="acc-order-summary__discount-value">-${formatCurrency(order.discount_amount)}</span>
                </div>
              ` : ''}
              <div class="acc-order-summary__row">
                <span>Shipping ${order.shipping_method ? `(${order.shipping_method})` : ''}</span>
                <span>${parseFloat(order.shipping_cost) === 0 ? '<span class="acc-order-summary__free">FREE</span>' : formatCurrency(order.shipping_cost)}</span>
              </div>
              <div class="acc-order-summary__row acc-order-summary__row--tax">
                <span>Tax (${order.tax_rate || 'HST/GST'})</span>
                <span>${formatCurrency(order.tax_amount)}</span>
              </div>
              <div class="acc-order-summary__row acc-order-summary__row--total">
                <span>Total</span>
                <span>${formatCurrency(order.total_amount || order.total)}</span>
              </div>
              ${order.payment_status === 'paid' ? `
                <div class="acc-order-summary__paid-badge">
                  <span class="material-symbols-rounded">check_circle</span>
                  Payment Complete
                </div>
              ` : ''}
            </div>
          </div>
        </div>

        ${order.notes && order.notes.length > 0 ? `
          <div class="acc-order-detail__section">
            <h4 class="acc-order-detail__section-title">
              <span class="material-symbols-rounded">note</span>
              Order Notes
            </h4>
            <div class="acc-order-notes">
              ${order.notes.map(note => `
                <div class="acc-order-note">
                  <p>${note.content}</p>
                  <span class="acc-order-note__date">${formatDateTime(note.created_at)}</span>
                </div>
              `).join('')}
            </div>
          </div>
        ` : ''}

        ${order.customer_note ? `
          <div class="acc-order-detail__section">
            <h4 class="acc-order-detail__section-title">
              <span class="material-symbols-rounded">chat</span>
              Your Note
            </h4>
            <div class="acc-customer-note">
              <p>${order.customer_note}</p>
            </div>
          </div>
        ` : ''}
      </div>
    `;
  }

  // Download Invoice
  function downloadInvoice() {
    const order = window.currentOrderData;
    if (!order) return;

    const orderNum = order.order_number || order.id;
    const totalItems = order.lines ? order.lines.reduce((sum, line) => sum + line.quantity, 0) : 0;
    const hasDiscount = order.discount_amount && parseFloat(order.discount_amount) > 0;

    const invoiceHTML = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Invoice #${orderNum} - PackAxis</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Arial, sans-serif; font-size: 14px; color: #333; line-height: 1.6; padding: 40px; }
    .invoice { max-width: 800px; margin: 0 auto; }
    .invoice-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 2px solid #0D7B7F; }
    .logo { font-size: 28px; font-weight: 700; color: #0D7B7F; }
    .logo span { color: #CCFF00; background: #0D7B7F; padding: 0 4px; }
    .invoice-title { text-align: right; }
    .invoice-title h1 { font-size: 24px; color: #0D7B7F; margin-bottom: 5px; }
    .invoice-title p { color: #666; }
    .invoice-meta { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
    .meta-section h3 { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: #999; margin-bottom: 8px; }
    .meta-section p { margin-bottom: 4px; }
    .meta-section .name { font-weight: 600; font-size: 15px; }
    .items-table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
    .items-table th { background: #f8f9fa; padding: 12px; text-align: left; font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #e9ecef; }
    .items-table td { padding: 12px; border-bottom: 1px solid #e9ecef; }
    .items-table .item-name { font-weight: 500; }
    .items-table .item-sku { font-size: 12px; color: #666; }
    .items-table .text-right { text-align: right; }
    .summary { margin-left: auto; width: 300px; }
    .summary-row { display: flex; justify-content: space-between; padding: 8px 0; }
    .summary-row.discount { color: #10b981; }
    .summary-row.total { font-size: 18px; font-weight: 700; border-top: 2px solid #0D7B7F; padding-top: 12px; margin-top: 8px; }
    .footer { margin-top: 50px; padding-top: 20px; border-top: 1px solid #e9ecef; text-align: center; color: #666; font-size: 12px; }
    .paid-stamp { display: inline-block; padding: 8px 16px; background: #d1fae5; color: #059669; font-weight: 600; border-radius: 4px; margin-top: 15px; }
    @media print { body { padding: 20px; } .invoice { max-width: none; } }
  </style>
</head>
<body>
  <div class="invoice">
    <div class="invoice-header">
      <div class="logo">Pack<span>Axis</span></div>
      <div class="invoice-title">
        <h1>INVOICE</h1>
        <p>Order #${orderNum}</p>
        <p>${formatDate(order.created_at)}</p>
      </div>
    </div>
    
    <div class="invoice-meta">
      <div class="meta-section">
        <h3>Bill To</h3>
        ${order.billing_address || order.shipping_address ? `
          <p class="name">${(order.billing_address || order.shipping_address).first_name} ${(order.billing_address || order.shipping_address).last_name}</p>
          ${(order.billing_address || order.shipping_address).company ? `<p>${(order.billing_address || order.shipping_address).company}</p>` : ''}
          <p>${(order.billing_address || order.shipping_address).address1}</p>
          <p>${(order.billing_address || order.shipping_address).city}, ${(order.billing_address || order.shipping_address).province} ${(order.billing_address || order.shipping_address).postal_code}</p>
        ` : '<p>Not available</p>'}
      </div>
      <div class="meta-section">
        <h3>Ship To</h3>
        ${order.shipping_address ? `
          <p class="name">${order.shipping_address.first_name} ${order.shipping_address.last_name}</p>
          ${order.shipping_address.company ? `<p>${order.shipping_address.company}</p>` : ''}
          <p>${order.shipping_address.address1}</p>
          <p>${order.shipping_address.city}, ${order.shipping_address.province} ${order.shipping_address.postal_code}</p>
        ` : '<p>Same as billing</p>'}
      </div>
    </div>

    <table class="items-table">
      <thead>
        <tr>
          <th>Item</th>
          <th class="text-right">Qty</th>
          <th class="text-right">Unit Price</th>
          <th class="text-right">Total</th>
        </tr>
      </thead>
      <tbody>
        ${order.lines ? order.lines.map(line => `
          <tr>
            <td>
              <div class="item-name">${line.product_name || 'Product'}</div>
              ${line.sku ? `<div class="item-sku">SKU: ${line.sku}</div>` : ''}
            </td>
            <td class="text-right">${line.quantity}</td>
            <td class="text-right">${formatCurrency(line.unit_price)}</td>
            <td class="text-right">${formatCurrency(line.unit_price * line.quantity)}</td>
          </tr>
        `).join('') : '<tr><td colspan="4">No items</td></tr>'}
      </tbody>
    </table>

    <div class="summary">
      <div class="summary-row">
        <span>Subtotal</span>
        <span>${formatCurrency(order.subtotal)}</span>
      </div>
      ${hasDiscount ? `
        <div class="summary-row discount">
          <span>Discount ${order.promo_code ? `(${order.promo_code})` : ''}</span>
          <span>-${formatCurrency(order.discount_amount)}</span>
        </div>
      ` : ''}
      <div class="summary-row">
        <span>Shipping</span>
        <span>${parseFloat(order.shipping_cost) === 0 ? 'FREE' : formatCurrency(order.shipping_cost)}</span>
      </div>
      <div class="summary-row">
        <span>Tax</span>
        <span>${formatCurrency(order.tax_amount)}</span>
      </div>
      <div class="summary-row total">
        <span>Total</span>
        <span>${formatCurrency(order.total_amount || order.total)}</span>
      </div>
      ${order.payment_status === 'paid' ? '<div class="paid-stamp">âœ“ PAID</div>' : ''}
    </div>

    <div class="footer">
      <p><strong>PackAxis Packaging Canada</strong></p>
      <p>Thank you for your business!</p>
      <p>Questions? Contact us at support@packaxis.ca</p>
    </div>
  </div>
</body>
</html>`;

    // Create blob and open print dialog
    const blob = new Blob([invoiceHTML], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const printWindow = window.open(url, '_blank');
    if (printWindow) {
      printWindow.onload = function() {
        printWindow.print();
      };
    }
  }

  // Render addresses
  function renderAddresses() {
    const container = document.getElementById('addresses-container');
    if (!container) return;

    if (addresses.length === 0) {
      container.innerHTML = `
        <div class="acc-empty acc-empty--addresses">
          <span class="material-symbols-rounded acc-empty__icon">location_off</span>
          <h4 class="acc-empty__title">No saved addresses</h4>
          <p class="acc-empty__text">Add addresses for faster checkout.</p>
          <button class="btn btn-primary" id="btn-add-address-empty" type="button">
            <span class="material-symbols-rounded">add</span>
            Add Your First Address
          </button>
        </div>
      `;
      document.getElementById('btn-add-address-empty')?.addEventListener('click', openAddAddressModal);
      return;
    }

    container.innerHTML = addresses.map(addr => `
      <div class="acc-address-card ${addr.is_default_shipping || addr.is_default_billing ? 'acc-address-card--default' : ''}">
        <div class="acc-address-card__header">
          <div class="acc-address-card__badges">
            ${addr.is_default_shipping ? '<span class="acc-address-card__badge">Default Shipping</span>' : ''}
            ${addr.is_default_billing ? '<span class="acc-address-card__badge acc-address-card__badge--billing">Default Billing</span>' : ''}
          </div>
          <span class="material-symbols-rounded acc-address-card__icon">location_on</span>
        </div>
        <div class="acc-address-card__body">
          <p class="acc-address-card__name">${addr.first_name} ${addr.last_name}</p>
          ${addr.company ? `<p class="acc-address-card__line">${addr.company}</p>` : ''}
          <p class="acc-address-card__line">${addr.address1}</p>
          ${addr.address2 ? `<p class="acc-address-card__line">${addr.address2}</p>` : ''}
          <p class="acc-address-card__line">${addr.city}, ${addr.province} ${addr.postal_code}</p>
          <p class="acc-address-card__line">${addr.country}</p>
          ${addr.phone ? `<p class="acc-address-card__phone">${addr.phone}</p>` : ''}
        </div>
        <div class="acc-address-card__actions">
          <button class="acc-address-card__btn" data-edit-address="${addr.id}" type="button">
            <span class="material-symbols-rounded">edit</span>
            Edit
          </button>
          <button class="acc-address-card__btn acc-address-card__btn--danger" data-delete-address="${addr.id}" type="button">
            <span class="material-symbols-rounded">delete</span>
            Delete
          </button>
        </div>
      </div>
    `).join('');
  }

  // Address modal functions
  function openAddAddressModal() {
    document.getElementById('address-modal-title').textContent = 'Add New Address';
    document.getElementById('address-id').value = '';
    document.getElementById('address-form').reset();
    document.getElementById('btn-save-address').textContent = 'Save Address';
    openModal('address-modal');
  }

  function openEditAddressModal(addressId) {
    const addr = addresses.find(a => a.id == addressId);
    if (!addr) return;

    document.getElementById('address-modal-title').textContent = 'Edit Address';
    document.getElementById('address-id').value = addr.id;
    document.getElementById('addr-first-name').value = addr.first_name || '';
    document.getElementById('addr-last-name').value = addr.last_name || '';
    document.getElementById('addr-company').value = addr.company || '';
    document.getElementById('addr-address1').value = addr.address1 || '';
    document.getElementById('addr-address2').value = addr.address2 || '';
    document.getElementById('addr-city').value = addr.city || '';
    document.getElementById('addr-province').value = addr.province || '';
    document.getElementById('addr-postal').value = addr.postal_code || '';
    document.getElementById('addr-phone').value = addr.phone || '';
    document.getElementById('addr-default-shipping').checked = addr.is_default_shipping;
    document.getElementById('addr-default-billing').checked = addr.is_default_billing;
    document.getElementById('btn-save-address').textContent = 'Update Address';
    openModal('address-modal');
  }

  async function saveAddress(e) {
    e.preventDefault();
    const addressId = document.getElementById('address-id').value;
    const isEdit = !!addressId;

    const data = {
      first_name: document.getElementById('addr-first-name').value.trim(),
      last_name: document.getElementById('addr-last-name').value.trim(),
      company: document.getElementById('addr-company').value.trim(),
      address1: document.getElementById('addr-address1').value.trim(),
      address2: document.getElementById('addr-address2').value.trim(),
      city: document.getElementById('addr-city').value.trim(),
      province: document.getElementById('addr-province').value,
      postal_code: document.getElementById('addr-postal').value.trim().toUpperCase(),
      country: 'CA',
      phone: document.getElementById('addr-phone').value.trim(),
      is_default_shipping: document.getElementById('addr-default-shipping').checked,
      is_default_billing: document.getElementById('addr-default-billing').checked
    };

    try {
      const url = isEdit ? `/api/accounts/addresses/${addressId}/` : '/api/accounts/addresses/';
      const method = isEdit ? 'PUT' : 'POST';

      const response = await fetch(url, {
        method,
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify(data)
      });

      if (response.ok) {
        closeModal('address-modal');
        await fetchAddresses();
        renderAddresses();
      } else {
        const err = await response.json();
        alert('Failed to save address: ' + (err.detail || JSON.stringify(err)));
      }
    } catch (error) {
      console.error('Error saving address:', error);
      alert('Failed to save address. Please try again.');
    }
  }

  async function deleteAddress(addressId) {
    if (!confirm('Are you sure you want to delete this address?')) return;

    try {
      const response = await fetch(`/api/accounts/addresses/${addressId}/`, {
        method: 'DELETE',
        headers: {
          'X-CSRFToken': getCsrfToken()
        }
      });

      if (response.ok) {
        await fetchAddresses();
        renderAddresses();
      } else {
        alert('Failed to delete address. Please try again.');
      }
    } catch (error) {
      console.error('Error deleting address:', error);
      alert('Failed to delete address. Please try again.');
    }
  }

  // Fetch data
  async function fetchOrders() {
    try {
      const response = await fetch('/api/orders/orders/');
      const data = await response.json();
      orders = data.results || [];
    } catch (error) {
      console.error('Failed to load orders:', error);
      orders = [];
    }
  }

  async function fetchAddresses() {
    try {
      const response = await fetch('/api/accounts/addresses/');
      const data = await response.json();
      addresses = data.results || data || [];
    } catch (error) {
      console.error('Failed to load addresses:', error);
      addresses = [];
    }
  }

  // Initialize
  document.addEventListener('DOMContentLoaded', async function() {
    // Check for tab query parameter
    const urlParams = new URLSearchParams(window.location.search);
    const tabParam = urlParams.get('tab');
    
    // Navigation event listeners
    document.querySelectorAll('[data-section]').forEach(element => {
      element.addEventListener('click', (e) => {
        const section = element.dataset.section;
        if (section) {
          e.preventDefault();
          showSection(section);
        }
      });
    });

    // Order filter buttons
    document.querySelectorAll('.acc-filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.acc-filter-btn').forEach(b => b.classList.remove('is-active'));
        btn.classList.add('is-active');
        currentFilter = btn.dataset.filter;
        renderOrdersList();
      });
    });

    // Modal event listeners
    document.querySelectorAll('.acc-modal__backdrop, .acc-modal__close').forEach(el => {
      el.addEventListener('click', () => {
        closeModal('address-modal');
        closeModal('order-modal');
      });
    });

    document.getElementById('btn-add-address')?.addEventListener('click', openAddAddressModal);
    document.getElementById('btn-cancel-address')?.addEventListener('click', () => closeModal('address-modal'));
    document.getElementById('address-form')?.addEventListener('submit', saveAddress);
    
    // Download invoice button
    document.getElementById('btn-download-invoice')?.addEventListener('click', downloadInvoice);

    // Delegate click events
    document.addEventListener('click', (e) => {
      const editBtn = e.target.closest('[data-edit-address]');
      const deleteBtn = e.target.closest('[data-delete-address]');
      const viewOrderBtn = e.target.closest('[data-view-order]');

      if (editBtn) {
        openEditAddressModal(editBtn.dataset.editAddress);
      }
      if (deleteBtn) {
        deleteAddress(deleteBtn.dataset.deleteAddress);
      }
      if (viewOrderBtn) {
        viewOrderDetails(viewOrderBtn.dataset.viewOrder);
      }
    });

    // Fetch initial data
    await Promise.all([fetchOrders(), fetchAddresses()]);
    
    updateStats();
    renderRecentOrders();

    // Handle tab parameter (e.g., from /orders/ redirect)
    if (tabParam && ['overview', 'orders', 'addresses', 'settings', 'wishlist'].includes(tabParam)) {
      showSection(tabParam);
    }

    // ========== WISHLIST FUNCTIONALITY ==========
    let wishlistItems = [];

    async function loadWishlist() {
      const container = document.getElementById('wishlist-content');
      const statsEl = document.getElementById('wishlist-stats');
      
      try {
        const response = await fetch('/api/wishlist/items/', {
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
          }
        });

        if (!response.ok) throw new Error('Failed to load wishlist');
        
        const data = await response.json();
        wishlistItems = Array.isArray(data) ? data : (data.results || data.items || []);
        renderWishlist();
        
        // Update stats
        if (wishlistItems.length > 0) {
          statsEl.style.display = 'flex';
          document.getElementById('wishlist-count').textContent = wishlistItems.length;
          document.getElementById('wishlist-in-stock').textContent = wishlistItems.filter(item => item.product?.stock_qty > 0).length;
        } else {
          statsEl.style.display = 'none';
        }
      } catch (error) {
        console.error('Error loading wishlist:', error);
        container.innerHTML = `
          <div class="acc-empty">
            <span class="material-symbols-rounded acc-empty__icon">error</span>
            <h4 class="acc-empty__title">Unable to load wishlist</h4>
            <p class="acc-empty__text">Please try again later.</p>
            <button class="btn btn-primary" onclick="loadWishlist()">Retry</button>
          </div>
        `;
      }
    }

    function renderWishlist() {
      const container = document.getElementById('wishlist-content');
      
      if (wishlistItems.length === 0) {
        container.innerHTML = `
          <div class="acc-wishlist-empty">
            <span class="material-symbols-rounded acc-wishlist-empty__icon">favorite_border</span>
            <h3 class="acc-wishlist-empty__title">Your wishlist is empty</h3>
            <p class="acc-wishlist-empty__text">Save products you love by clicking the heart icon on any product page.</p>
            <a href="/products/" class="btn btn-primary">
              <span class="material-symbols-rounded">storefront</span>
              Browse Products
            </a>
          </div>
        `;
        return;
      }

      const html = `
        <div class="acc-wishlist-grid">
          ${wishlistItems.map(item => {
            const product = item.product || {};
            const stockQty = product.stock_qty || 0;
            const stockStatus = stockQty > 10 ? 'in-stock' : stockQty > 0 ? 'low-stock' : 'out-of-stock';
            const stockText = stockQty > 10 ? 'In Stock' : stockQty > 0 ? `Only ${stockQty} left` : 'Out of Stock';
            const imageUrl = product.image_url || product.image || product.primary_image || '/media/product_images/placeholder.jpg';
            const price = product.price ? parseFloat(product.price).toFixed(2) : '0.00';
            
            return `
              <div class="acc-wishlist-item" data-wishlist-id="${item.id}" data-product-id="${product.id}">
                <button class="acc-wishlist-item__remove" onclick="removeFromWishlist(${product.id})" title="Remove from wishlist">
                  <span class="material-symbols-rounded">close</span>
                </button>
                <a href="/products/${product.id}/" class="acc-wishlist-item__image">
                  <img src="${imageUrl}" alt="${product.name || 'Product'}" loading="lazy">
                </a>
                <div class="acc-wishlist-item__content">
                  <a href="/products/${product.id}/" class="acc-wishlist-item__title">${product.name || 'Unknown Product'}</a>
                  <div class="acc-wishlist-item__meta">
                    <span class="acc-wishlist-item__price">${price}</span>
                    <span class="acc-wishlist-item__badge acc-wishlist-item__badge--${stockStatus}">${stockText}</span>
                  </div>
                  <div class="acc-wishlist-item__actions">
                    ${stockQty > 0 ? `
                      <button class="btn btn-primary btn-sm" onclick="addToCartFromWishlist(${product.id})">
                        <span class="material-symbols-rounded">add_shopping_cart</span>
                        Add to Cart
                      </button>
                    ` : `
                      <button class="btn btn-secondary btn-sm" disabled>
                        <span class="material-symbols-rounded">inventory_2</span>
                        Out of Stock
                      </button>
                    `}
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
      
      container.innerHTML = html;
    }

    async function removeFromWishlist(productId) {
      if (!confirm('Remove this item from your wishlist?')) return;
      
      try {
        const response = await fetch(`/api/wishlist/items/by-product/${productId}/`, {
          method: 'DELETE',
          headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
          }
        });

        if (!response.ok) throw new Error('Failed to remove item');
        
        wishlistItems = wishlistItems.filter(item => item.product?.id !== productId);
        renderWishlist();
        
        // Update stats
        const statsEl = document.getElementById('wishlist-stats');
        if (wishlistItems.length > 0) {
          document.getElementById('wishlist-count').textContent = wishlistItems.length;
          document.getElementById('wishlist-in-stock').textContent = wishlistItems.filter(item => item.product?.stock_qty > 0).length;
        } else {
          statsEl.style.display = 'none';
        }
        
        showToast('Item removed from wishlist', 'success');
      } catch (error) {
        console.error('Error removing from wishlist:', error);
        showToast('Failed to remove item', 'error');
      }
    }

    async function addToCartFromWishlist(productId) {
      try {
        const response = await fetch('/api/cart/items/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
          },
          body: JSON.stringify({ product_id: productId, quantity: 1 })
        });

        if (!response.ok) throw new Error('Failed to add to cart');
        
        showToast('Added to cart!', 'success');
        
        // Update cart count in header if exists
        const cartCountEl = document.querySelector('.cart-count, #cart-count');
        if (cartCountEl) {
          const currentCount = parseInt(cartCountEl.textContent) || 0;
          cartCountEl.textContent = currentCount + 1;
        }
      } catch (error) {
        console.error('Error adding to cart:', error);
        showToast('Failed to add to cart', 'error');
      }
    }

    function showToast(message, type = 'info') {
      // Check if toast function exists globally
      if (typeof window.showNotification === 'function') {
        window.showNotification(message, type);
        return;
      }
      
      // Fallback toast
      const toast = document.createElement('div');
      toast.className = `acc-toast acc-toast--${type}`;
      toast.innerHTML = `
        <span class="material-symbols-rounded">${type === 'success' ? 'check_circle' : type === 'error' ? 'error' : 'info'}</span>
        <span>${message}</span>
      `;
      toast.style.cssText = `
        position: fixed;
        bottom: 24px;
        right: 24px;
        padding: 12px 20px;
        background: ${type === 'success' ? '#0D7B7F' : type === 'error' ? '#dc3545' : '#333'};
        color: white;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
        z-index: 10000;
        animation: slideIn 0.3s ease;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      `;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // Make functions globally accessible for onclick handlers
    window.loadWishlist = loadWishlist;
    window.removeFromWishlist = removeFromWishlist;
    window.addToCartFromWishlist = addToCartFromWishlist;

    // Load wishlist when tab is clicked
    document.querySelector('[data-section="wishlist"]')?.addEventListener('click', () => {
      if (wishlistItems.length === 0) loadWishlist();
    });

    // Also load if URL has ?tab=wishlist
    if (tabParam === 'wishlist') {
      loadWishlist();
    }
    // ========== END WISHLIST FUNCTIONALITY ==========

    // Handle error states
    if (orders.length === 0) {
      document.getElementById('recent-orders-container').innerHTML = `
        <div class="acc-empty">
          <span class="material-symbols-rounded acc-empty__icon">inventory_2</span>
          <h4 class="acc-empty__title">No orders yet</h4>
          <p class="acc-empty__text">Start shopping to see your orders here.</p>
          <a href="/products/" class="btn btn-primary">Browse Products</a>
        </div>
      `;
    }

    // Form submissions (placeholder)
    document.getElementById('profile-form')?.addEventListener('submit', (e) => {
      e.preventDefault();
      alert('Profile update feature coming soon!');
    });

    document.getElementById('password-form')?.addEventListener('submit', (e) => {
      e.preventDefault();
      alert('Password update feature coming soon!');
    });
  });
})();
</script>
{% endblock %}
