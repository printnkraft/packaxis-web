{% extends 'base.html' %}
{% load static %}

{% block title %}{{ post.meta_title|default:post.title }} | PackAxis Blog{% endblock %}
{% block meta_description %}{{ post.meta_description|default:post.excerpt }}{% endblock %}

{% block extra_head %}
<!-- SEO Meta Tags -->
<meta name="author" content="{{ post.author.get_full_name|default:post.author.username }}">
<meta name="keywords" content="{{ post.tags.all|join:', ' }}">
<link rel="canonical" href="{{ request.build_absolute_uri }}">

<!-- Open Graph -->
<meta property="og:title" content="{{ post.meta_title|default:post.title }}">
<meta property="og:description" content="{{ post.meta_description|default:post.excerpt }}">
<meta property="og:type" content="article">
<meta property="og:url" content="{{ request.build_absolute_uri }}">
{% if post.featured_image %}
<meta property="og:image" content="{{ request.scheme }}://{{ request.get_host }}{{ post.featured_image.url }}">
{% endif %}
<meta property="article:published_time" content="{{ post.published_at|date:'c' }}">
<meta property="article:author" content="{{ post.author.get_full_name|default:post.author.username }}">
{% if post.category %}
<meta property="article:section" content="{{ post.category.name }}">
{% endif %}

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="{{ post.meta_title|default:post.title }}">
<meta name="twitter:description" content="{{ post.meta_description|default:post.excerpt }}">
{% if post.featured_image %}
<meta name="twitter:image" content="{{ request.scheme }}://{{ request.get_host }}{{ post.featured_image.url }}">
{% endif %}

<!-- Schema.org Article Structured Data -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "{{ post.title|escapejs }}",
  "description": "{{ post.excerpt|escapejs }}",
  "image": "{% if post.featured_image %}{{ request.scheme }}://{{ request.get_host }}{{ post.featured_image.url }}{% endif %}",
  "datePublished": "{{ post.published_at|date:'c' }}",
  "dateModified": "{{ post.updated_at|date:'c' }}",
  "author": {
    "@type": "Person",
    "name": "{{ post.author.get_full_name|default:post.author.username|escapejs }}"
  },
  "publisher": {
    "@type": "Organization",
    "name": "PackAxis",
    "logo": {
      "@type": "ImageObject",
      "url": "{{ request.scheme }}://{{ request.get_host }}{% static 'logo/packaxis dark-font.png' %}"
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "{{ request.build_absolute_uri }}"
  }
}
</script>

<!-- BreadcrumbList Schema -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {"@type": "ListItem", "position": 1, "name": "Home", "item": "{{ request.scheme }}://{{ request.get_host }}{% url 'home' %}"},
    {"@type": "ListItem", "position": 2, "name": "Blog", "item": "{{ request.scheme }}://{{ request.get_host }}{% url 'content:blog_list' %}"},
    {"@type": "ListItem", "position": 3, "name": "{{ post.title|escapejs }}", "item": "{{ request.build_absolute_uri }}"}
  ]
}
</script>
{% endblock %}

{% block content %}
<!-- Breadcrumb Navigation -->
<nav class="breadcrumb-nav" aria-label="Breadcrumb">
  <div class="container">
    <ol class="breadcrumb-list" itemscope itemtype="https://schema.org/BreadcrumbList">
      <li class="breadcrumb-item" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a href="{% url 'home' %}" itemprop="item"><span itemprop="name">Home</span></a>
        <meta itemprop="position" content="1">
      </li>
      <li class="breadcrumb-item" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a href="{% url 'content:blog_list' %}" itemprop="item"><span itemprop="name">Blog</span></a>
        <meta itemprop="position" content="2">
      </li>
      <li class="breadcrumb-item active" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <span itemprop="name" aria-current="page">{{ post.title|truncatewords:6 }}</span>
        <meta itemprop="position" content="3">
      </li>
    </ol>
  </div>
</nav>

<article class="blog-article" itemscope itemtype="https://schema.org/BlogPosting">
  <!-- Article Header -->
  <header class="blog-article__header">
    <div class="container">
      <div class="blog-article__header-content">
        {% if post.category %}
        <a href="{% url 'content:blog_list' %}?category={{ post.category.slug }}" class="blog-article__category">
          {{ post.category.name }}
        </a>
        {% endif %}
        
        <h1 class="blog-article__title" itemprop="headline">{{ post.title }}</h1>
        
        <p class="blog-article__excerpt" itemprop="description">{{ post.excerpt }}</p>
        
        <div class="blog-article__meta">
          <div class="blog-article__author" itemprop="author" itemscope itemtype="https://schema.org/Person">
            <div class="blog-article__author-avatar">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
            </div>
            <div class="blog-article__author-info">
              <span class="blog-article__author-name" itemprop="name">{{ post.author.get_full_name|default:post.author.username }}</span>
              <span class="blog-article__author-role">Content Writer</span>
            </div>
          </div>
          
          <div class="blog-article__stats">
            <span class="blog-article__stat">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
              </svg>
              <time datetime="{{ post.published_at|date:'c' }}" itemprop="datePublished">{{ post.published_at|date:"F d, Y" }}</time>
            </span>
            <span class="blog-article__stat">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                <circle cx="12" cy="12" r="3"></circle>
              </svg>
              {{ post.views_count }} views
            </span>
            <span class="blog-article__stat">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
              5 min read
            </span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Featured Image -->
  {% if post.featured_image %}
  <figure class="blog-article__hero-image">
    <div class="container">
      <div class="blog-article__image-wrapper">
        <img src="{{ post.featured_image.url }}" alt="{{ post.title }}" itemprop="image" loading="eager">
        <div class="blog-article__image-overlay"></div>
      </div>
    </div>
  </figure>
  {% endif %}

  <!-- Article Content -->
  <div class="blog-article__body">
    <div class="container">
      <div class="blog-article__layout">
        <!-- Main Content -->
        <div class="blog-article__content" itemprop="articleBody">
          {{ post.content|safe }}
        </div>

        <!-- Sidebar -->
        <aside class="blog-article__sidebar">
          <!-- Table of Contents -->
          <div class="blog-article__toc">
            <h3 class="blog-article__toc-title">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="8" y1="6" x2="21" y2="6"></line>
                <line x1="8" y1="12" x2="21" y2="12"></line>
                <line x1="8" y1="18" x2="21" y2="18"></line>
                <line x1="3" y1="6" x2="3.01" y2="6"></line>
                <line x1="3" y1="12" x2="3.01" y2="12"></line>
                <line x1="3" y1="18" x2="3.01" y2="18"></line>
              </svg>
              In This Article
            </h3>
            <nav class="blog-article__toc-nav" id="toc-nav">
              <!-- Generated by JavaScript -->
            </nav>
          </div>

          <!-- Share Widget -->
          <div class="blog-article__share">
            <h3 class="blog-article__share-title">Share This Article</h3>
            <div class="blog-article__share-buttons">
              <a href="https://twitter.com/intent/tweet?text={{ post.title|urlencode }}&url={{ request.build_absolute_uri }}" 
                 target="_blank" 
                 rel="noopener noreferrer"
                 class="blog-share-btn blog-share-btn--twitter"
                 aria-label="Share on Twitter">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                </svg>
              </a>
              <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri }}" 
                 target="_blank" 
                 rel="noopener noreferrer"
                 class="blog-share-btn blog-share-btn--facebook"
                 aria-label="Share on Facebook">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                </svg>
              </a>
              <a href="https://www.linkedin.com/sharing/share-offsite/?url={{ request.build_absolute_uri }}" 
                 target="_blank" 
                 rel="noopener noreferrer"
                 class="blog-share-btn blog-share-btn--linkedin"
                 aria-label="Share on LinkedIn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                </svg>
              </a>
              <button type="button" class="blog-share-btn blog-share-btn--copy" onclick="copyToClipboard()" aria-label="Copy link">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                  <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                </svg>
              </button>
            </div>
          </div>

          <!-- Newsletter CTA -->
          <div class="blog-article__newsletter">
            <svg class="blog-article__newsletter-icon" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
              <polyline points="22,6 12,13 2,6"></polyline>
            </svg>
            <h4 class="blog-article__newsletter-title">Stay Updated</h4>
            <p class="blog-article__newsletter-text">Get packaging insights delivered to your inbox.</p>
            <form class="blog-article__newsletter-form" action="#" method="post">
              {% csrf_token %}
              <input type="email" name="email" placeholder="Enter your email" required>
              <button type="submit" class="btn btn-accent">Subscribe</button>
            </form>
          </div>
        </aside>
      </div>
    </div>
  </div>

  <!-- Article Footer -->
  <footer class="blog-article__footer">
    <div class="container">
      <div class="blog-article__footer-content">
        <!-- Tags -->
        {% if post.tags.all %}
        <div class="blog-article__tags">
          <span class="blog-article__tags-label">Tags:</span>
          {% for tag in post.tags.all %}
          <a href="{% url 'content:blog_list' %}?tag={{ tag.slug }}" class="blog-article__tag">{{ tag.name }}</a>
          {% endfor %}
        </div>
        {% endif %}

        <!-- Navigation -->
        <div class="blog-article__nav">
          <a href="{% url 'content:blog_list' %}" class="blog-article__back">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="19" y1="12" x2="5" y2="12"></line>
              <polyline points="12 19 5 12 12 5"></polyline>
            </svg>
            Back to Blog
          </a>
        </div>
      </div>
    </div>
  </footer>
</article>

<!-- Related Posts -->
{% if related_posts %}
<section class="blog-related">
  <div class="container">
    <div class="section-header section-header--center">
      <span class="section-header__label">Keep Reading</span>
      <h2 class="section-header__title">Related Articles</h2>
      <p class="section-header__subtitle">More insights on sustainable packaging</p>
    </div>
    
    <div class="blog-grid">
      {% for related in related_posts %}
      <article class="blog-card" itemscope itemtype="https://schema.org/BlogPosting">
        {% if related.featured_image %}
        <a href="{{ related.get_absolute_url }}" class="blog-card__image">
          <img src="{{ related.featured_image.url }}" alt="{{ related.title }}" loading="lazy" itemprop="image">
          <div class="blog-card__image-overlay"></div>
        </a>
        {% else %}
        <a href="{{ related.get_absolute_url }}" class="blog-card__image blog-card__image--placeholder">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <circle cx="8.5" cy="8.5" r="1.5"></circle>
            <polyline points="21 15 16 10 5 21"></polyline>
          </svg>
        </a>
        {% endif %}
        
        <div class="blog-card__content">
          {% if related.category %}
          <a href="{% url 'content:blog_list' %}?category={{ related.category.slug }}" class="blog-card__category">
            {{ related.category.name }}
          </a>
          {% endif %}
          
          <h3 class="blog-card__title" itemprop="headline">
            <a href="{{ related.get_absolute_url }}">{{ related.title }}</a>
          </h3>
          
          <p class="blog-card__excerpt" itemprop="description">{{ related.excerpt|truncatewords:15 }}</p>
          
          <footer class="blog-card__footer">
            <time class="blog-card__date" datetime="{{ related.published_at|date:'c' }}" itemprop="datePublished">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
              </svg>
              {{ related.published_at|date:"M d, Y" }}
            </time>
            <a href="{{ related.get_absolute_url }}" class="blog-card__read-more">
              Read More
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="5" y1="12" x2="19" y2="12"></line>
                <polyline points="12 5 19 12 12 19"></polyline>
              </svg>
            </a>
          </footer>
        </div>
      </article>
      {% endfor %}
    </div>
  </div>
</section>
{% endif %}

<script>
// Generate Table of Contents
document.addEventListener('DOMContentLoaded', function() {
  const content = document.querySelector('.blog-article__content');
  const tocNav = document.getElementById('toc-nav');
  const headings = content.querySelectorAll('h2, h3');
  
  if (headings.length > 0 && tocNav) {
    const tocList = document.createElement('ul');
    tocList.className = 'blog-article__toc-list';
    
    headings.forEach((heading, index) => {
      // Add ID to heading if not present
      if (!heading.id) {
        heading.id = 'section-' + index;
      }
      
      const li = document.createElement('li');
      li.className = 'blog-article__toc-item blog-article__toc-item--' + heading.tagName.toLowerCase();
      
      const a = document.createElement('a');
      a.href = '#' + heading.id;
      a.textContent = heading.textContent;
      a.className = 'blog-article__toc-link';
      
      a.addEventListener('click', function(e) {
        e.preventDefault();
        heading.scrollIntoView({ behavior: 'smooth', block: 'start' });
      });
      
      li.appendChild(a);
      tocList.appendChild(li);
    });
    
    tocNav.appendChild(tocList);
  } else if (tocNav) {
    tocNav.parentElement.style.display = 'none';
  }
});

// Copy to clipboard
function copyToClipboard() {
  navigator.clipboard.writeText(window.location.href).then(function() {
    const btn = document.querySelector('.blog-share-btn--copy');
    btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>';
    setTimeout(() => {
      btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>';
    }, 2000);
  });
}
</script>
{% endblock %}
